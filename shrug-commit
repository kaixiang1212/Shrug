#!/bin/dash

IFS="
"

# Constants
commit_dir=".shrug/commit"
index_dir=".shrug/index"
log_file=".shrug/log"
shrug_cmp="shrug-cmp"
shrug_add="shrug-add"
usage="usage: shrug-commit [-a] -m commit-message"

# Check if .shrug exists
if [ ! -d ".shrug" ]
then
    echo "$0: error: no .shrug directory containing shrug repository exists" >> /dev/stderr
    exit 1;
fi

# Check argument number
if [ $# -lt 2 ]
then
    echo $usage
    exit 1
# Process Arguments
else
    while [ $1 ]
    do 
        if echo $1 | egrep "^-m$" > /dev/null && echo $2 | egrep -v "^-.+" > /dev/null
        then
            msg=$2
            shift
        elif echo $1 | egrep "^-a$" > /dev/null
        then
            for file in `find $index_dir -type f`
            do
                filename=`basename $file`
                # echo "$filename"
                `$shrug_add $filename`
                # echo "update $file"
            done
        else
            echo $usage
            exit 1
        fi
        shift
    done
fi

# Check if repo has previous commit
commit_no=0
if [ ! -f .shrug/commit_no ]
then
    mkdir .shrug/commit
    echo $commit_no > .shrug/commit_no
else
    commit_no=`cat .shrug/commit_no`
    commit_no=$(($commit_no+1))
fi

last_commit_no="`find .shrug/commit -mindepth 1 -type d -exec basename {} \; | sort | tail -1`"
# echo "$commit_no $msg" >> ".shrug/log.txt"
if [ ! $last_commit_no = "" ]
then           # Not initial commit
    differ=`$shrug_cmp "$index_dir" "$commit_dir/$last_commit_no" `
    if [ -n "$differ" ]
    then
        for line in $differ
        do
            file=` echo $line | cut -d " " -f2 `
        done
        cp -r "$index_dir/." "$commit_dir/$commit_no"
        echo "$commit_no $msg" >> "$log_file"
        echo "$commit_no" > .shrug/commit_no
        echo "Committed as commit $commit_no"
    else
        echo "nothing to commit"
    fi
else                            # Initial commit
    cp -r "$index_dir/." "$commit_dir/$commit_no"
    echo "$commit_no $msg" >> "$log_file"
    echo "$commit_no" > .shrug/commit_no
    echo "Committed as commit $commit_no"
fi

# cp -r ".shrug/index/." ".shrug/commit/$commit" &&
# echo "Committed as commit $commit_no"
